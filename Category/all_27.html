<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	       凌云阁
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="       凌云阁" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}

	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
				 	<div class="profilepic">
						<img src="https://i.loli.net/2020/02/22/Si1K7sluept2ZgR.jpg" style="width:160px;">
					</div>
            	
					
					<h1><a href="index.html">       凌云阁</a></h1>
					<p class="subtitle">生命的意义是成为你自己！</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="_self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">

<a target="_blank" class="facebook" href="www.facebook.com" title="Facebook">Facebook</a>






<a target="_blank" class="weibo" href="www.weibo.com" title="weibo">Weibo</a>
<a target="_blank" class="twitter" target="_blank" href="www.twitter.com" title="Twitter">Twitter</a>
<a target="_blank" class="github" target="_blank" href="www.github.com/chawlau" title="GitHub">GitHub</a>


								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-09-13T07:01:27+08:00" itemprop="datePublished">2019/09/13 07:01 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Redis%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.html'>Redis从入门到精通</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15683292874011.html" itemprop="url">
		布隆过滤器</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>实现原理</h4>
<ul>
<li>一个很长的二进制向量和若干个哈希函数<br />
<img src="media/15683292874011/15683294091882.jpg" alt="" style="width:1004px;" /></li>
<li>参数：m 个二进制向量，n 个预备数据，k 个 hash 函数构建布隆过滤器：n 个预备数据走一遍上面过程</li>
<li>判断元素存在：走一遍上面过程：如果都是 1, 则在表明存在，反之不存在。</li>
</ul>
<h4><a id="%E8%AF%AF%E5%B7%AE%E7%8E%87" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>误差率</h4>
<ul>
<li><img src="media/15683292874011/15683296943543.jpg" alt="" style="width:981px;" /></li>
<li>m/n与误差率成反比。k与误差率成反比</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2021-01-04T06:39:40+08:00" itemprop="datePublished">2021/01/04 06:39 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A.html'>系统性能调优必知必会</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16097135804073.html" itemprop="url">
		GEO</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E4%BA%8C%E5%88%86%E5%8C%BA%E9%97%B4%EF%BC%8C%E5%8C%BA%E9%97%B4%E7%BC%96%E7%A0%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>二分区间，区间编码</h4>
<ul>
<li>经度范围[-180,180]会被分成两个子区间</li>
<li>如果是落在左分区，我们就用 0 表示；如果落在右分区，就用 1 表示</li>
<li>维度范围[-90, 90]会被分成两个子区间</li>
<li>如果是落在左分区，我们就用 0 表示；如果落在右分区，就用 1 表示</li>
</ul>
<h4><a id="%E7%BB%84%E5%90%88%E8%A7%84%E5%88%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>组合规则</h4>
<ul>
<li>一组经纬度值都编完码后，我们再把它们的各自编码值组合在一起，组合的规则是：最终编码值的偶数位上依次是经度的编码值，奇数位上依次是纬度的编码值</li>
<li>有的编码值虽然在大小上接近，但实际对应的方格却距离比较远</li>
</ul>
<h4><a id="%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>操作指令</h4>
<ul>
<li>GEOADD</li>
<li>GEORADIUS</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2021-01-03T11:48:57+08:00" itemprop="datePublished">2021/01/03 11:48 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Redis%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98.html'>Redis核心技术与实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16096457379778.html" itemprop="url">
		海量key统计</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E8%81%9A%E5%90%88%E7%BB%9F%E8%AE%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>聚合统计</h4>
<ul>
<li>使用set</li>
</ul>
<h4><a id="%E6%8E%92%E5%BA%8F%E7%BB%9F%E8%AE%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>排序统计</h4>
<ul>
<li>zset sorted set</li>
</ul>
<h4><a id="%E4%BA%8C%E5%80%BC%E7%8A%B6%E6%80%81%E7%BB%9F%E8%AE%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>二值状态统计</h4>
<ul>
<li>只需要统计数据的二值状态，例如商品有没有、用户在不在等，就可以使用 Bitmap，因为它只用一个 bit 位就能表示 0 或 1。在记录海量数据时，Bitmap 能够有效地节省内存空间。</li>
</ul>
<h4><a id="%E5%9F%BA%E6%95%B0%E7%BB%9F%E8%AE%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>基数统计</h4>
<ul>
<li>HyperLogLog 的统计规则是基于概率完成的，所以它给出的统计结果是有一定误差的，标准误算率是 0.81%</li>
</ul>
<h4><a id="%E7%BB%BC%E5%90%88" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>综合</h4>
<ul>
<li><img src="media/16096457379778/16096458946561.jpg" alt="" /></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2020-12-29T18:16:40+08:00" itemprop="datePublished">2020/12/29 18:16 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A.html'>系统性能调优必知必会</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16092370003370.html" itemprop="url">
		各种锁机制</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E5%8C%BA%E5%88%AB" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>区别</h4>
<ul>
<li>互斥锁能够满足各类功能性要求，特别是被锁住的代码执行时间不可控时，它通过内核执行线程切换及时释放了资源，但它的性能消耗最大。需要注意的是，协程的互斥锁实现原理完全不同，它并不与内核打交道，虽然不能跨线程工作，但效率很高</li>
<li>如果能够确定被锁住的代码取到锁后很快就能释放，应该使用更高效的自旋锁，它特别适合基于异步编程实现的高并发服务</li>
<li>当并发访问共享资源，冲突概率非常低的时候，可以选择无锁编程。它在 Web 和数据库中有广泛的应用。然而，一旦冲突概率上升，就不适合使用它，因为它解决冲突的重试成本非常高</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2020-12-28T07:01:25+08:00" itemprop="datePublished">2020/12/28 07:01 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A.html'>系统性能调优必知必会</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16091100851189.html" itemprop="url">
		内存池</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="java%E5%86%85%E5%AD%98%E6%B1%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>JAVA内存池</h4>
<ul>
<li>Java 已经有了应用层内存池，为什么还会受到 C 库内存池的影响呢？</li>
<li>JVM 负责管理的堆内存外，Java 还拥有一些堆外内存，由于它不使用 JVM 的垃圾回收机制，所以更稳定、持久，处理 IO 的速度也更快</li>
<li>子线程预分配的内存是64MB</li>
</ul>
<h4><a id="%E8%B0%83%E6%95%B4ptmalloc2" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>调整Ptmalloc2</h4>
<ul>
<li>MALLOC_ARENA_MAX 可以限制线程内存池的最大数量</li>
<li>每次分配内存，Ptmalloc2 一定要加锁，才能解决共享资源的互斥问题。然而，加锁的消耗并不小</li>
<li>TCMalloc 针对小内存做了很多优化，每个线程独立分配内存，无须加锁，所以速度更快</li>
<li>当应用场景涉及大量的并发线程时，换成 TCMalloc 库也更有优势</li>
<li>如果主要分配 256KB 以下的内存，特别是在多线程环境下，应当选择 TCMalloc；否则应使用 Ptmalloc2，它的通用性更好</li>
</ul>
<h4><a id="%E4%B8%BA%E4%BB%80%E4%B9%88%E6%A0%88%E4%B8%8A%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>为什么栈上分配内存</h4>
<ul>
<li>由于每个线程都有独立的栈，所以分配内存时不需要加锁保护，而且栈上对象的尺寸在编译阶段就已经写入可执行文件了，执行效率更高</li>
<li>Go语言就是但编译器如果认为在栈中分配不影响功能语义时，会自动改为在栈中分配</li>
</ul>
<h4><a id="%E6%9B%B4%E6%8D%A2c%E5%BA%93%E5%86%85%E5%AD%98%E6%B1%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>更换C库内存池</h4>
<ul>
<li>export LD_PRELOAD=&quot;&quot;; ./benchmark -s 262144 -t 1</li>
<li>export LD_PRELOAD=&quot;/lib64/libtcmalloc.so&quot;; ./benchmark -s 262144 -t 1</li>
</ul>
<h4><a id="%E6%80%9D%E8%80%83%E9%A2%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>思考题</h4>
<ul>
<li>分配对象时，除了分配内存，还需要初始化对象的数据结构。内存池对于初始化对象有什么帮助吗？</li>
<li>内存池中可以利用享元模式将常用的对象一直保留着，减少重复申请导致的性能的顺耗</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-12-29T16:48:34+08:00" itemprop="datePublished">2019/12/29 16:48 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E9%AB%98%E6%89%8B%E8%AF%BE.html'>性能工程高手课</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15776093141221.html" itemprop="url">
		常见性能数字</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E5%AD%98%E5%82%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>存储</h4>
<ul>
<li>IO读写延迟。一般是用 4 KB 大小的 IO 做基准来测试</li>
<li>IO带宽，一般是针对比较大的IO而言</li>
<li>IOPS，就是每秒钟可以读写多少个小的随机 1 O</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2020-12-25T09:26:49+08:00" itemprop="datePublished">2020/12/25 09:26 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%AE%AE%E5%92%8C%E7%AE%97%E6%B3%95%E5%AE%9E%E6%88%98.html'>分布式协议和算法实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16088596096551.html" itemprop="url">
		拜占庭将军问题</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%B1%E8%AF%86%E9%97%AE%E9%A2%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>解决分布式系统的共识问题</h4>
<ul>
<li>如果叛将人数为 m，将军人数不能少于 3m + 1 ，那么拜占庭将军问题就能解决了</li>
<li>：n 位将军，最多能容忍 (n - 1) / 3 位叛将</li>
</ul>
<h4><a id="%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%B9%E9%94%99%E7%AE%97%E6%B3%95" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>常见分布式容错算法</h4>
<ul>
<li>CFT 解决的是分布式的系统中存在故障，但不存在恶意节点的场景下的共识问题</li>
<li>拜占庭容错算法（Byzantine Fault Tolerance，BFT）</li>
<li>PoW 算法</li>
</ul>
<h4><a id="%E7%AD%BE%E5%90%8D%E6%B6%88%E6%81%AF%E7%9A%84%E6%8B%9C%E5%8D%A0%E5%BA%AD%E4%B9%8B%E8%A7%A3" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>签名消息的拜占庭之解</h4>
<ul>
<li>需要进行 m+1 轮（其中 m 为叛将数</li>
<li>n 位将军，能容忍 (n - 2) 位叛将</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2020-12-22T09:29:54+08:00" itemprop="datePublished">2020/12/22 09:29 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Redis%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98.html'>Redis核心技术与实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16086005946318.html" itemprop="url">
		AOF</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E9%87%87%E7%94%A8wal" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>为什么不采用WAL</h4>
<ul>
<li>为了避免额外的检查开销，Redis 在向 AOF 里面记录日志的时候，并不会先去对这些命令进行语法检查。所以，如果先记日志再执行命令的话，日志中就有可能记录了错误的命令，Redis 在使用日志恢复数据时，就可能会出错</li>
</ul>
<h4><a id="aof%E6%97%A5%E5%BF%97%E9%87%8D%E5%86%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>AOF日志重写</h4>
<ul>
<li><img src="media/16086005946318/16086006674750.jpg" alt="" /></li>
<li>一个拷贝，两处日志</li>
<li>每次执行重写时，主线程 fork 出后台的 bgrewriteaof 子进程。此时，fork 会把主线程的内存拷贝一份给 bgrewriteaof 子进程，这里面就包含了数据库的最新数据</li>
<li>第一处日志就是指正在使用的 AOF 日志，Redis 会把这个操作写到它的缓冲区</li>
<li>就是指新的 AOF 重写日志。这个操作也会被写到重写日志的缓冲区。这样，重写日志也不会丢失最新的操作</li>
<li>两个缓冲区 AOF缓冲和AOF重写缓冲</li>
</ul>
<h4><a id="aof%E9%87%8D%E5%86%99%E9%98%BB%E5%A1%9E%E9%A3%8E%E9%99%A9" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>AOF重写阻塞风险</h4>
<ul>
<li>fork采用写时复制，fork子进程需要拷贝进程必要的数据结构，其中有一项就是拷贝内存页表（虚拟内存和物理内存的映射索引表），这个拷贝过程会消耗大量CPU资源，拷贝完成之前整个进程是会阻塞的，阻塞时间取决于整个实例的内存大小，实例越大，内存页表越大，fork阻塞时间越久</li>
<li>操作系统开启了内存大页机制(Huge Page，页面大小2M)，那么父进程申请内存时阻塞的概率将会大大提高，所以在Redis机器上需要关闭Huge Page机制</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-11-07T06:32:49+08:00" itemprop="datePublished">2019/11/07 06:32 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html'>设计模式</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15730795693761.html" itemprop="url">
		Clone</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E6%A8%A1%E5%BC%8F%E5%AE%9A%E4%B9%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>模式定义</h4>
<ul>
<li>使用原型实例指定创建对象的种类，然后通过拷贝这些原型来创建新的对象。</li>
</ul>
<h4><a id="%E7%BB%93%E6%9E%84" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>结构</h4>
<p><img src="media/15730795693761/15806429826202.jpg" alt="" style="width:719px;" /></p>
<h4><a id="%E5%8A%A8%E6%9C%BA" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>动机</h4>
<ul>
<li>在软件系统中，经常面临着“某些结构复杂的对象“的创建工作；由于需求的变化，这些对象经常面临着剧烈的变化，但是它们却拥有七较稳定一致的接口。</li>
<li>如何应对这种变化？如何向“客户程序（使用这些对象的程序）“隔离出“这些易变对象”，从而使得“依赖这些易变对象的客户程序”不随着需求改变而改变？</li>
</ul>
<h4><a id="%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>要点总结</h4>
<ul>
<li>Prototype 模式同样用于隔离类对象的使用者和具体类型（易变类）之间的耦合关系，它同样要求这些“易变类”拥有“稳定的接口“”。</li>
<li>Prototype 模式对于“如何创建易变类的实体对象”“采用“原型克隆”的方法来做，它使得我们可以非常灵活地动态创建“拥有某些稳定接口“的新对象一一所需工作仅仅是注册一个新类的对象（即原型然后在任何需要的地方 Clone。</li>
<li>Prototype 模式中的 Clone 方法可以利用某些框架中的序列化来实现深拷贝。</li>
</ul>
<h4><a id="cpp-demo" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>cpp_demo</h4>
<pre><code class="language-C++">#include &lt;iostream&gt;

using namespace std;

class Monkey {
 public:
  Monkey() {}

  virtual Monkey* Clone() = 0;
  virtual void Play() = 0;
};

class Goku : public Monkey {
 public:
  Goku(const string&amp; name) : _name(name) {}
  Goku(const Goku&amp; other) {_name = other._name;}
  ~Goku() {}

  Monkey* Clone() {
    return new Goku(*this);
  }

  void Play() {std::cout &lt;&lt; &quot; Goku Playing&quot; &lt;&lt; std::endl;}
  string _name;
};

int main() {
  Monkey* m = new Goku(&quot;QitianDasheng&quot;);
  Monkey* m1 = m-&gt;Clone();
  Monkey* m2 = m-&gt;Clone();
  Monkey* m3 = m-&gt;Clone();
  m1-&gt;Play();
  m2-&gt;Play();
  m3-&gt;Play();
}
</code></pre>
<h3><a id="golang-demo" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>golang_demo</h3>
<pre><code class="language-go">package prototype

import &quot;fmt&quot;

type Monkey interface {
        Clone() Monkey
        Play()
}

type Goku struct{}

func (g *Goku) Clone() Monkey {
        return &amp;Goku{}
}

func (g *Goku) Play() {
        fmt.Println(&quot;Goku Play&quot;)
}
func TestPrototype(t *testing.T) {
        var m Monkey = &amp;Goku{}
        m1 := m.Clone()
        m2 := m.Clone()
        m3 := m.Clone()
        m1.Play()
        m2.Play()
        m3.Play()
}
</code></pre>
<h4><a id="python-code" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>python_code</h4>
<pre><code class="language-python">
from abc import ABCMeta, abstractmethod

class Prototype(metaclass=ABCMeta):
    @abstractmethod
    def clone(self):
        pass
        
import copy


class Knight(object):
    def __init__(self, level):
        self.unit_type = &quot;knight&quot;

        file_name = &quot;./{}_{}.dat&quot;.format(self.unit_type, level)
        print(file_name)
        with open(file_name, 'r') as parameter_file:
            lines = parameter_file.read().split(&quot;\n&quot;)
            self.life = lines[0]
            self.attack_power = lines[1]
            self.attack_range = lines[2]
            self.weapon = lines[3]
            self.speed = lines[4]

    def __str__(self):
        return &quot;Life: {0} Speed: {1} &quot; \
               &quot; Attack Power: {2}&quot; \
               &quot; Attack Range: {3}&quot; \
               &quot; Weapon: {4}&quot; \
               &quot; Type: {5}&quot;.format(self.life,
                                   self.speed,
                                   self.attack_power,
                                   self.attack_range,
                                   self.weapon,
                                   self.unit_type)

    def clone(self):
        return copy.deepcopy(self)


class Archer(object):
    def __init__(self, level):
        self.unit_type = &quot;archer&quot;

        file_name = &quot;./{}_{}.dat&quot;.format(self.unit_type, level)
        print(file_name)
        with open(file_name, 'r') as parameter_file:
            lines = parameter_file.read().split(&quot;\n&quot;)
            self.life = lines[0]
            self.attack_power = lines[1]
            self.attack_range = lines[2]
            self.weapon = lines[3]
            self.speed = lines[4]

    def __str__(self):
        return &quot;Life: {0} Speed: {1} &quot; \
               &quot; Attack Power: {2}&quot; \
               &quot; Attack Range: {3}&quot; \
               &quot; Weapon: {4}&quot; \
               &quot; Type: {5}&quot;.format(self.life,
                                   self.speed,
                                   self.attack_power,
                                   self.attack_range,
                                   self.weapon,
                                   self.unit_type)

    def clone(self):
        return copy.deepcopy(self)


class Barracks(object):

    def __init__(self):
        self.units = {
            &quot;knight&quot;: {
                1: Knight(1),
            },
            &quot;archer&quot;: {
                2: Archer(2),
            }
        }

    def build_units(self, unit_type, level):
        return self.units[unit_type][level].clone()


if __name__ == '__main__':
    barracks = Barracks()
    archer1 = barracks.build_units(&quot;archer&quot;, 2)
    knight1 = barracks.build_units(&quot;knight&quot;, 1)
    print('knight {}'.format(knight1))
    print('archer {}'.format(archer1))
</code></pre>
<h4><a id="%E5%BB%BA%E7%AD%91%E8%80%85%E5%92%8C%E7%AE%80%E5%8E%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>建筑者和简历</h4>
<pre><code class="language-go">package design_pattern

type ProtoType interface {
	clone() ProtoType
}

type Knight struct {
	Name,Weapon string
}

func (k *Knight) clone() ProtoType {
	knight := (*k)
	return &amp;knight
}

func (k *Knight) setWeapon(weapon string) {
	k.Weapon = weapon
}

type Archer struct {
	Name,Weapon string
}

func (r *Archer) clone() ProtoType {
	archer := (*r)
	return &amp;archer
}

type Barracks struct {
	units map[string]interface{}
}

func NewBarracks() *Barracks {
	return &amp;Barracks{
		units: make(map[string]interface{}),
	}
}

func (b *Barracks) Add(name string, types ProtoType) {
	b.units[name] = types
}

func (b *Barracks) Build(name string) ProtoType {
	return b.units[name].(ProtoType).clone()
}

type WorkExperience struct {
	date, company string
}


func (w *WorkExperience) clone() ProtoType {
	work := (*w)
	return &amp;work
}

type PersonInfo struct {
	name, sex, age string
}

type Resume struct {
	name, sex, age string
	work *WorkExperience
}

func (r *Resume) clone() ProtoType {
	resume := &amp;Resume{
		name: r.name,
	}
	return resume
}

func (r *Resume) setPerson(sex, age string) {
	r.sex, r.age = sex, age
}

func (r *Resume) setWork(date, company string) {
	r.work = &amp;WorkExperience{}
	r.work.date, r.work.company = date, company
}

package design_pattern

import (
	&quot;fmt&quot;
	&quot;testing&quot;
)

func TestPrototype(t *testing.T) {
	barracks := NewBarracks()
	knight := &amp;Knight{&quot;knight&quot;, &quot;long bow&quot;}
	archer := &amp;Archer{&quot;archer&quot;, &quot;short bow&quot;}
	barracks.Add(&quot;knight&quot;, knight)
	barracks.Add(&quot;archer&quot;, archer)

	k1 := barracks.Build(&quot;knight&quot;)
	a1 := barracks.Build(&quot;archer&quot;)
	k2 := barracks.Build(&quot;knight&quot;)
	a2 := barracks.Build(&quot;archer&quot;)
	fmt.Println(k1, a1)
	fmt.Println(k2, a2)
}

func TestResume(t *testing.T) {
	var resume ProtoType = &amp;Resume{name : &quot;a&quot;}
	resume.(*Resume).setPerson(&quot;male&quot;, &quot;29&quot;)
	resume.(*Resume).setWork(&quot;2019-02-01&quot;, &quot;apple&quot;)

	resume2 := resume.clone()
	resume2.(*Resume).setPerson(&quot;male&quot;, &quot;30&quot;)
	resume2.(*Resume).setWork(&quot;2019-02-17&quot;, &quot;alia&quot;)
	fmt.Println(resume, resume2)
}
</code></pre>
<h4><a id="cpp-code" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>cpp_code</h4>
<pre><code class="language-C++">//
// Created by eredinliu on 2020-02-02.
//

#include &lt;iostream&gt;

using namespace std;

class IClone {
public:
    virtual IClone* Clone() = 0;
    virtual void Show() = 0;
    virtual void Coding() = 0;
    IClone() {}
};

class Person : public IClone {
public:
    Person(const string&amp; name, __const string&amp; age) : name_(name), age_(age) {}

    IClone* Clone() {
        IClone* copy = new Person(this-&gt;name_, this-&gt;age_);
        return copy;
    }

    void Show() {
        cout &lt;&lt; &quot;I'm &quot; &lt;&lt; this-&gt;name_ &lt;&lt; &quot; age &quot; &lt;&lt; this-&gt;age_ &lt;&lt; endl;
    }

    void Coding() {
        cout &lt;&lt; &quot;I'm programmer, coding change world \n&quot;;
    }

private:
    string name_, age_;
};

int main() {
    IClone* person = new Person(&quot;tony&quot;, &quot;27&quot;);

    IClone* clone = person-&gt;Clone();
    clone-&gt;Coding();
    clone-&gt;Show();
}
</code></pre>
<h4><a id="golang-code" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>golang_code</h4>
<pre><code class="language-go">package desian_pattern_practise


type IClone interface {
	Clone() IClone
	Show()
	Coding()
}

type Career struct {
	name, age string
}

func (c *Career) Show() {
	println(&quot;I'm&quot;, c.name, &quot;Age&quot;, c.age)
}

func (c *Career) Coding() {
	println(&quot;I'm programmer, coding change world&quot;)
}

func (c *Career) Clone() IClone {
	return &amp;Career{
		name: c.name,
		age: c.age,
	}
}

func TestCareer_Clone(t *testing.T) {
	career := &amp;Career{&quot;ming&quot;, &quot;IT&quot;}

	var c1 IClone = career.Clone()
	c1.Show()
	c1.Coding()
}
</code></pre>
<h4><a id="python-code" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>python_code</h4>
<pre><code class="language-python">from copy import copy, deepcopy

class Clone(object):

    def clone(self):
        return copy(self)

    def deep_clone(self):
        return deepcopy(self)

class Person(Clone):

    def __init__(self, name, age):
        self.__name = name
        self.__age = age

    def show(self):
        print(&quot;I'm {} age {}&quot;.format(self.__name, self.__age))

    def coding(self):
        print(&quot;I'm programmer, coding change world&quot;)

    def reading(self):
        print('reading make me happy')

    def fall_love(self):
        print('fall in love')

if __name__ == '__main__':

    tony = Person('tony', 27)
    tony.show()
    tony.coding()

    tony1 = tony.clone()
    tony.show()
    tony.coding()
</code></pre>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 <a class="prev" href="all_26.html">Prev</a>  
	 <a class="next" href="all_28.html">Next</a> 
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    



</body>
</html>