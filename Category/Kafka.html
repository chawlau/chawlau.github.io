<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	Kafka -        凌云阁
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="       凌云阁" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}

	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
				 	<div class="profilepic">
						<img src="https://i.loli.net/2020/02/22/Si1K7sluept2ZgR.jpg" style="width:160px;">
					</div>
            	
					
					<h1><a href="index.html">       凌云阁</a></h1>
					<p class="subtitle">生命的意义是成为你自己！</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="_self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">

<a target="_blank" class="facebook" href="www.facebook.com" title="Facebook">Facebook</a>






<a target="_blank" class="weibo" href="www.weibo.com" title="weibo">Weibo</a>
<a target="_blank" class="twitter" target="_blank" href="www.twitter.com" title="Twitter">Twitter</a>
<a target="_blank" class="github" target="_blank" href="www.github.com/chawlau" title="GitHub">GitHub</a>


								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-07-21T17:37:56+08:00" itemprop="datePublished">2019/07/21 17:37 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15637018763027.html" itemprop="url">
		kafka无消息丢失配置</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E5%8F%AF%E9%9D%A0%E6%80%A7" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>可靠性</h4>
<ul>
<li>Kafka 只对“已提交”的消息（committed message）做有限度的持久化保证</li>
</ul>
<h4><a id="%E7%94%9F%E4%BA%A7%E8%80%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>生产者</h4>
<ul>
<li>Producer 永远要使用带有回调通知的发送 API，也就是说不要使用 producer.send(msg)，而要使用 producer.send(msg, callback)</li>
</ul>
<h4><a id="%E6%B6%88%E8%B4%B9%E8%80%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>消费者</h4>
<ul>
<li>如果是多线程异步处理消费消息，Consumer 程序不要开启自动提交位移，而是要应用程序手动提交位移，需要消费未消费Consumer 程序自动地向前更新位移</li>
</ul>
<h4><a id="%E9%85%8D%E7%BD%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>配置</h4>
<ul>
<li>发送方法带回调</li>
<li>所有副本都收到消息才算提交</li>
<li>生产者多次重试</li>
<li>落后太多的broker禁止竞选leader</li>
<li>三副本冗余策略</li>
<li>写入多副本才算提交</li>
<li>确保 replication.factor &gt; min.insync.replicas。如果两者相等，那么只要有一个副本挂机，整个分区就无法正常工作了。我们不仅要改善消息的持久性，防止数据丢失，还要在不降低可用性的基础上完成。推荐设置成 replication.factor = min.insync.replicas + 1。</li>
<li>手动提交位移</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-07-14T11:45:40+08:00" itemprop="datePublished">2019/07/14 11:45 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15630759404599.html" itemprop="url">
		消费者组避免重平衡</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E5%8D%8F%E8%B0%83%E8%80%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>协调者</h4>
<ul>
<li>专门为 Consumer Group 服务，负责为 Group 执行 Rebalance 以及提供位移管理和组成员管理等</li>
</ul>
<h4><a id="%E7%A1%AE%E5%AE%9Acoordinator%E6%89%80%E5%9C%A8broker" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>确定Coordinator所在broker</h4>
<ul>
<li>确定由位移主题的哪个分区来保存该 Group 数据：</li>
<li>找出该分区 Leader 副本所在的 Broker，该 Broker 即为对应的 Coordinator</li>
</ul>
<h4><a id="rebalance%E6%9C%BA%E5%88%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>rebalance机制</h4>
<ul>
<li>Rebalance 影响 Consumer 端 TPS。这个之前也反复提到了，这里就不再具体讲了。总之就是，在 Rebalance 期间，Consumer 会停下手头的事情，什么也干不了。</li>
<li>Rebalance 很慢</li>
<li>Rebalance 效率不高。当前 Kafka 的设计机制决定了每次 Rebalance 时，Group 下的所有成员都要参与进来，而且通常不会考虑局部性原理，但局部性原理对提升系统性能是特别重要的</li>
</ul>
<h4><a id="%E8%A7%84%E9%81%BF" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>规避</h4>
<ul>
<li>Consumer实例会被 Coordinator 错误地认为“已停止”从而被“踢出”Group</li>
<li>session.timout.ms 决定了 Consumer 存活性的时间间隔</li>
<li>heartbeat.interval.ms 心跳间隔</li>
<li>max.poll.interval.ms 参数。它限定了 Consumer 端应用程序两次调用 poll 方法的最大时间间隔</li>
<li>第一类 Rebalance 是因为未能及时发送心跳，导致 Consumer 被“踢出”Group 而引发的</li>
<li>第二类非必要 Rebalance 是 Consumer 消费时间过长导致的</li>
<li>Consumer 端的 GC 表现，比如是否出现了频繁的 Full GC 导致的长时间停顿，从而引发了 Rebalance</li>
</ul>
<h4><a id="%E6%80%BB%E7%BB%93" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>总结</h4>
<ul>
<li>session.timeout.ms=6s</li>
<li>heartbeat.interval.ms=2s</li>
<li>max.poll.interval.ms， 比根据下游客户端消费者将数据写入持久化设备的时间略长一点</li>
<li>GC参数 消费端是否出现了频繁的 Full GC 导致的长时间停顿，从而引发了 Rebalance，现实业务非常常见，</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-07T21:59:28+08:00" itemprop="datePublished">2019/08/07 21:59 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15651863685389.html" itemprop="url">
		主题管理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E4%B8%BB%E9%A2%98%E5%8F%98%E6%9B%B4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>主题变更</h4>
<ul>
<li>主题分区变更</li>
<li>主题级别参数</li>
<li>变更副本</li>
<li>修改主题限速</li>
</ul>
<pre><code class="language-plain_text">bin/kafka-configs.sh --zookeeper zookeeper_host:port --alter --add-config 'leader.replication.throttled.rate=104857600,follower.replication.throttled.rate=104857600' --entity-type brokers --entity-name 0

bin/kafka-configs.sh --zookeeper zookeeper_host:port --alter --add-config 'leader.replication.throttled.replicas=*,follower.replication.throttled.replicas=*' --entity-type topics --entity-name test

</code></pre>
<ul>
<li>主题分区迁移</li>
</ul>
<pre><code class="language-plain_text">bin/kafka-topics.sh --bootstrap-server broker_host:port --delete  --topic &lt;topic_name&gt;
</code></pre>
<h4><a id="%E4%B8%BB%E9%A2%98%E7%AE%A1%E7%90%86%E5%92%8C%E8%BF%90%E7%BB%B4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>主题管理和运维</h4>
<ul>
<li>查看消费者组状态</li>
</ul>
<pre><code class="language-plain_text">kafka-console-consumer.sh --bootstrap-server master:9092 --topic __consumer_offsets --formatter &quot;kafka.coordinator.group.GroupMetadataManager\$GroupMetadataMessageFormatter&quot; --from-beginning
</code></pre>
<h4><a id="%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>常见问题</h4>
<h5><a id="%E4%B8%BB%E9%A2%98%E5%88%A0%E9%99%A4%E5%A4%B1%E8%B4%A5%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>主题删除失败怎么处理</h5>
<ul>
<li>第 1 步，手动删除 ZooKeeper 节点 /admin/delete_topics 下以待删除主题为名的 znode。</li>
<li>第 2 步，手动删除该主题在磁盘上的分区目录。</li>
<li>第 3 步，在 ZooKeeper 中执行 rmr /controller，触发 Controller 重选举，刷新 Controller 缓存。</li>
</ul>
<h5><a id="consumer-offsets%E5%8D%A0%E7%94%A8%E5%A4%AA%E5%A4%9A%E7%9A%84%E7%A3%81%E7%9B%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>__consumer_offsets占用太多的磁盘</h5>
<ul>
<li>kafka-log-cleaner-thread 前缀的线程挂掉了</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-04T22:13:04+08:00" itemprop="datePublished">2019/08/04 22:13 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15649279845988.html" itemprop="url">
		Kafka控制器</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="watch" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>watch</h4>
<ul>
<li>所谓的 Watch 通知功能。一旦 znode 节点被创建、删除，子节点数量发生变化，抑或是 znode 所存的数据本身变更，ZooKeeper 会通过节点变更监听器 (ChangeHandler) 的方式显式通知客户端</li>
</ul>
<h4><a id="%E6%8E%A7%E5%88%B6%E5%99%A8%E6%95%B0%E6%8D%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>控制器数据</h4>
<p><img src="media/15649279845988/38ff78fdeb2a86943ae60f15c3ad28c8.jpg" alt="38ff78fdeb2a86943ae60f15c3ad28" /></p>
<h4><a id="%E6%8E%A7%E5%88%B6%E5%99%A8%E7%BB%84%E4%BB%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>控制器组件</h4>
<ul>
<li>控制器组件（Controller），是 Apache Kafka 的核心组件。它的主要作用是在 Apache ZooKeeper 的帮助下管理和协调整个 Kafka 集群</li>
<li>主题管理</li>
<li>分区重分配</li>
<li>领导者选举</li>
<li>集群成员管理 存活机制 每个 Broker 启动后，会在 /brokers/ids 下创建一个临时 znode。当 Broker 宕机或主动关闭后，该 Broker 与 ZooKeeper 的会话结束，这个 znode 会被自动删除。通过watch机制观察</li>
<li>数据服务</li>
</ul>
<h4><a id="%E5%86%85%E9%83%A8%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>内部设计原理</h4>
<ul>
<li>统一处理各种控制</li>
<li><img src="media/15649279845988/b14c6f2d246cbf637f2fda5dae1688e5.png" alt="b14c6f2d246cbf637f2fda5dae1688e5" /><br />
器事件，然后控制器将原来执行的操作全部建模成一个个独立的事件，发送到专属的事件队列中，供此线程消费</li>
<li>之前同步操作 ZooKeeper 全部改为异步操作</li>
</ul>
<h4><a id="%E5%BF%AB%E9%80%9F%E5%88%A0%E9%99%A4%E4%B8%BB%E9%A2%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>快速删除主题</h4>
<ul>
<li>ZooKeeper 中手动删除 /controller 节点</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-23T08:05:35+08:00" itemprop="datePublished">2019/08/23 08:05 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15665187356600.html" itemprop="url">
		kafka认证</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>认证机制</h4>
<ul>
<li>Broker和客户端的双路认证</li>
<li>SASL</li>
</ul>
<h4><a id="%E5%AF%B9%E6%AF%94" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>对比</h4>
<ul>
<li>SASL/SCRAM支持用户的动态删减</li>
</ul>
<h4><a id="scram" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>SCRAM</h4>
<ul>
<li>创建broker</li>
</ul>
<pre><code class="language-plain_text">  KafkaServer {
  org.apache.kafka.common.security.scram.ScramLoginModule required
  username=&quot;admin&quot;
  password=&quot;admin&quot;;
};--&gt;kafka_broker_jaas.conf
</code></pre>
<ul>
<li>启动broker</li>
</ul>
<pre><code class="language-plain_text">export KAFKA_OPTS=-Djava.security.auth.login.config=/root/kafka_2.12-2.2.0/config/kafka_broker_jaas.conf &amp;&amp; kafka-server-start.sh server1.properties
</code></pre>
<ul>
<li>启动生产者</li>
</ul>
<pre><code class="language-plain_text">producer.conf
security.protocol=SASL_PLAINTEXT
sasl.mechanism=SCRAM-SHA-256
sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;writer&quot; password=&quot;writer&quot;; --&gt;producer.conf
kafka-console-producer.sh --broker-list master:9092,node1:9093 --topic test_ssl  --producer.config producer.conf
</code></pre>
<ul>
<li>启动消费者</li>
</ul>
<pre><code class="language-plain_text">consumer.conf
security.protocol=SASL_PLAINTEXT
sasl.mechanism=SCRAM-SHA-256
sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;reader&quot; password=&quot;reader&quot;; --&gt;consumer.conf
kafka-console-consumer.sh --bootstrap-server master:9092,node1:9093 --topic test --from-beginning --consumer.config consumer.conf
</code></pre>
<ul>
<li>删除用户</li>
</ul>
<pre><code class="language-plain_text">kafka-configs.sh --zookeeper localhost:2181 --alter --delete-config 'SCRAM-SHA-256' --entity-type users --entity-name writer
kafka-configs.sh --zookeeper localhost:2181 --alter --delete-config 'SCRAM-SHA-512' --entity-type users --entity-name writer
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-13T21:23:06+08:00" itemprop="datePublished">2019/08/13 21:23 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15657025865667.html" itemprop="url">
		kafka工具</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>生产者和消费者性能测试</h4>
<ul>
<li>kafka-producer-perf-test.sh --topic test1 --num-records 10000000 --throughput -1 --record-size 1024 --producer-props bootstrap.servers=master:9092 acks=-1 linger.ms=2000 compression.type=lz4</li>
<li>kafka-consumer-perf-test.sh --broker-list master:9092 --messages 10000000 --topic test1</li>
</ul>
<h4><a id="%E6%9F%A5%E7%9C%8B%E6%B6%88%E6%81%AF%E4%B8%BB%E9%A2%98%E7%9A%84%E6%80%BB%E6%95%B0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>查看消息主题的总数</h4>
<ul>
<li>kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list master:9092 --time -2 --topic test1</li>
<li>kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list master:9092 --time -1 --topic test1</li>
</ul>
<h4><a id="%E6%B6%88%E6%81%AF%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>消息文件数据</h4>
<ul>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-12T21:25:14+08:00" itemprop="datePublished">2019/08/12 21:25 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15656163148085.html" itemprop="url">
		重设消费者位移</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E6%B6%88%E6%81%AF%E5%BC%95%E6%93%8E" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>消息引擎</h4>
<ul>
<li>它是基于日志结构（log-based）的消息引擎，消费者在消费消息时，仅仅是从磁盘文件上读取数据而已，是只读的操作，因此消费者不会删除消息数据。同时，由于位移数据是由消费者控制的，因此它能够很容易地修改位移的值，实现重复消费历史数据的功能。</li>
</ul>
<h4><a id="%E9%87%8D%E8%AE%BE%E4%BD%8D%E7%A7%BB%E7%AD%96%E7%95%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>重设位移策略</h4>
<ul>
<li>位移维度</li>
<li>时间维度</li>
</ul>
<h4><a id="%E5%90%84%E7%A7%8D%E7%AD%96%E7%95%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>各种策略</h4>
<ul>
<li><img src="media/15656163148085/eb469122e5af2c9f6baebb173b56bed5.jpeg" alt="eb469122e5af2c9f6baebb173b56bed5" /></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-08T21:19:16+08:00" itemprop="datePublished">2019/08/08 21:19 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15652703560020.html" itemprop="url">
		Kafka动态配置</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="dynamic-update-mode" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dynamic Update Mode</h4>
<ul>
<li>read-only</li>
<li>pre-broker</li>
<li>cluster-wide</li>
</ul>
<h4><a id="%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用场景</h4>
<ul>
<li>动态调整 Broker 端各种线程池大小，实时应对突发流量。</li>
<li>动态调整 Broker 端连接信息或安全配置信息。</li>
<li>动态更新 SSL Keystore 有效期。</li>
<li>动态调整 Broker 端 Compact 操作性能。</li>
<li>实时变更 JMX 指标收集器 (JMX Metrics Reporter)。</li>
</ul>
<h4><a id="%E5%8F%82%E6%95%B0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>参数</h4>
<ul>
<li>log.retention.ms 日志停留时长</li>
<li>num.io.threads 和 num.network.threads。</li>
<li>SSL参数ssl.keystore.type、ssl.keystore.location、ssl.keystore.password 和 ssl.key.password</li>
<li>num.replica.fetchers 增加该参数值，确保有充足的线程可以执行 Follower 副本向 Leader 副本的拉取</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-08-04T22:29:53+08:00" itemprop="datePublished">2019/08/04 22:29 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Kafka.html'>Kafka</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15649289939803.html" itemprop="url">
		高水位和Leader epoch</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E9%AB%98%E6%B0%B4%E4%BD%8D%E4%BD%9C%E7%94%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>高水位作用</h4>
<ul>
<li>定义消息可见性，即用来标识分区下的哪些消息是可以被消费者消费的。</li>
<li>帮助 Kafka 完成副本同步</li>
<li><img src="media/15649289939803/c2243d5887f0ca7a20a524914b85a8dd.png" alt="c2243d5887f0ca7a20a524914b85a8dd" /></li>
<li>高水位和 LEO 是副本对象的两个重要属性。Kafka 所有副本都有对应的高水位和 LEO 值，而不仅仅是 Leader 副本</li>
</ul>
<h4><a id="%E9%AB%98%E6%B0%B4%E4%BD%8D%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>高水位更新机制</h4>
<ul>
<li>leader的broker保存远程副本，帮助leader副本 确定高水位</li>
<li>leader的LEO通过生产者消息写入磁盘更新</li>
<li>folloer副本通过拉取消息，更新磁盘</li>
<li>follower副本高水位取LEO和leader发来的高水位最小值确定高水位</li>
<li>leader副本高水位取leader副本和所有同步的leo的最小值</li>
<li>leader远程副本leo通过follower拉取消息上报的位移算</li>
</ul>
<h4><a id="%E5%89%AF%E6%9C%AC%E5%90%8C%E6%AD%A5%E5%88%A4%E6%96%AD" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>副本同步判断</h4>
<ul>
<li>该远程 Follower 副本在 ISR 中。</li>
<li>该远程 Follower 副本 LEO 值落后于 Leader 副本 LEO 值的时间，不超过 Broker 端参数 replica.lag.time.max.ms 的值</li>
<li>先更新leo，然后更新高水位</li>
</ul>
<h4><a id="leader-epoch" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Leader Epoch</h4>
<ul>
<li>Epoch。一个单调增加的版本号。每当副本领导权发生变更时，都会增加该版本号。小版本号的 Leader 被认为是过期 Leader，不能再行使 Leader 权力。</li>
<li>起始位移（Start Offset）。Leader 副本在该 Epoch 值上写入的首条消息的位移。</li>
</ul>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 
	 <a class="next" href="Kafka_1.html">Next</a> 
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    



</body>
</html>