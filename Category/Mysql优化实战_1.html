<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	Mysql优化实战 -        凌云阁
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="       凌云阁" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}

	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
				 	<div class="profilepic">
						<img src="https://i.loli.net/2020/02/22/Si1K7sluept2ZgR.jpg" style="width:160px;">
					</div>
            	
					
					<h1><a href="index.html">       凌云阁</a></h1>
					<p class="subtitle">生命的意义是成为你自己！</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="_self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">

<a target="_blank" class="facebook" href="www.facebook.com" title="Facebook">Facebook</a>






<a target="_blank" class="weibo" href="www.weibo.com" title="weibo">Weibo</a>
<a target="_blank" class="twitter" target="_blank" href="www.twitter.com" title="Twitter">Twitter</a>
<a target="_blank" class="github" target="_blank" href="www.github.com/chawlau" title="GitHub">GitHub</a>


								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2018-12-27T09:23:26+08:00" itemprop="datePublished">2018/12/27 09:23 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15458738062017.html" itemprop="url">
		加快插入数据</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<pre><code class="language-plain_text">  set global innodb_flush_log_at_trx_commit=0;
  set global sync_binlog=0;
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-01-22T18:02:42+08:00" itemprop="datePublished">2019/01/22 18:02 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15481513628351.html" itemprop="url">
		主库出问题</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>主备切换</h4>
<p><img src="media/15481513628351/aadb3b956d1ffc13ac46515a7d619e79.png" alt="aadb3b956d1ffc13ac46515a7d619e79" /></p>
<pre><code class="language-plain_text"> CHANGE MASTER TO 
MASTER_HOST=$host_name 
MASTER_PORT=$port 
MASTER_USER=$user_name 
MASTER_PASSWORD=$password 
MASTER_LOG_FILE=$master_log_name 
MASTER_LOG_POS=$master_log_pos  
</code></pre>
<ul>
<li>MASTER_LOG_FILE和MASTER_LOG_POS就是主库对应的文件名和日志偏移量就是同步位点</li>
</ul>
<h4><a id="%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E9%94%99%E8%AF%AF" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>主备切换错误</h4>
<ul>
<li>主动跳过一个事物</li>
<li>set global sql_slave_skip_counter=1;</li>
<li>start slave;</li>
<li>跳过指定的错误</li>
<li>slave_skip_errors=1032,1062</li>
</ul>
<h4><a id="gtid%E5%92%8C%E5%9C%A8%E7%BA%BFddl" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>GTID和在线DDL</h4>
<ul>
<li>互为主备关系的库X是主库，Y是从库</li>
<li>在实例 X 上执行 stop slave。</li>
<li>在实例 Y 上执行 DDL 语句。注意，这里并不需要关闭 binlog。</li>
<li>执行完成后，查出这个 DDL 语句对应的 GTID，并记为 server_uuid_of_Y:gno。</li>
<li>到实例 X 上执行以下语句序列：</li>
</ul>
<pre><code class="language-plain_text">set GTID_NEXT=&quot;3c8f3ed7-f85e-11e8-b414-fa163e483aea:1002077&quot;;
begin;
commit;
set gtid_next=automatic;
start slave;
</code></pre>
<h4><a id="mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E9%85%8D%E7%BD%AE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>mysql主从复制的配置</h4>
<pre><code class="language-plain_text">[mysqld]
#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
#log_bin=ON
#log_bin_basename=/var/lib/mysql/mysql-bin
#log_bin_index=/var/lib/mysql/mysql-bin.index
server-id=1
log-bin=/var/lib/mysql/mysql-binlog.log
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock

# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
long_query_time=0
slow_query_log=ON
slow_query_log_file=/var/lib/mysql/host4-slow.log

server_id=100
binlog-ignore-db=mysql
log-bin=edu-mysql-bin
binlog_cache_size=1M
binlog_format=mixed
expire_logs_days=7
slave_skip_errors=1062
gtid_mode = ON
enforce_gtid_consistency = ON
</code></pre>
<h4><a id="slave%E8%B7%B3%E8%BF%87%E6%8C%87%E5%AE%9A%E4%BA%8B%E7%89%A9" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>slave跳过指定事物</h4>
<pre><code class="language-plain_text">show slave status;
Executed_Gtid_Set: 94b06c13-1f09-11e5-97ea-000c29c8caec:1-10
stop slave;
set gtid_next='3c8f3ed7-f85e-11e8-b414-fa163e483aea:6';
begin;
commit;
set gtid_next=automatic;
start slave;
show slave status;
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-01-30T09:56:25+08:00" itemprop="datePublished">2019/01/30 09:56 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15488133858576.html" itemprop="url">
		无法Kill的语句</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="kill" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>kill</h4>
<ul>
<li>kill query</li>
<li>kill connection</li>
</ul>
<h4><a id="kill-query%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>kill query执行原理</h4>
<ul>
<li>把 session B 的运行状态改成 THD::KILL_QUERY(将变量 killed 赋值为 THD::KILL_QUERY)；</li>
<li>给 session B 的执行线程发一个信号。让session退出等待，处理THD:KILL_QUERY</li>
<li>等行锁时，使用的是 pthread_cond_timedwait 函数，这个等待状态可以被唤醒,等待进入InnoDB的循环过程中，没有去判断线程的状态，所以不会进入逻辑终止阶段</li>
<li>pthread_cond_timedwait 函数，这个等待状态可以被唤醒</li>
<li>如果没有判断线程的状态，就不会被唤醒</li>
</ul>
<h4><a id="kill-connection" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>kill connection</h4>
<ul>
<li>把 12 号线程状态设置为 KILL_CONNECTION；</li>
<li>关掉 12 号线程的网络连接。</li>
<li>线程依然是killed状态，直到满足进入InnoDB条件后，才会判断线程状态，最后进入终止逻辑状态</li>
</ul>
<h4><a id="kill%E6%97%A0%E6%95%88" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>kill无效</h4>
<ul>
<li>线程没有执行到判断线程状态的逻辑</li>
<li>终止逻辑耗时比较长</li>
<li>超大事物被kill</li>
<li>大查询回滚</li>
<li>DDL命令执行到最后阶段</li>
</ul>
<h4><a id="%E5%AE%A2%E6%88%B7%E7%AB%AF" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>客户端</h4>
<ul>
<li>连接后操作</li>
<li>执行 show databases；</li>
<li>切到 db1 库，执行 show tables；</li>
<li>把这两个命令的结果用于构建一个本地的哈希表。</li>
</ul>
<h4><a id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9F%A5%E8%AF%A2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>客户端查询返回结果</h4>
<ul>
<li>一种是本地缓存，也就是在本地开一片内存，先把结果存起来。API 开发，对应的就是 mysql_store_result 方法。</li>
<li>另一种是不缓存，读一个处理一个。API开发，对应的就是 mysql_use_result 方法。-quick参数</li>
</ul>
<h4><a id="quick%E5%8F%82%E6%95%B0%E6%95%88%E6%9E%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>quick参数效果</h4>
<ul>
<li>第一点，就是前面提到的，跳过表名自动补全功能。</li>
<li>第二点，mysql_store_result 需要申请本地内存来缓存查询结果，如果查询结果太大，会耗费较多的本地内存，可能会影响客户端本地机器的性能；</li>
<li>第三点，是不会把执行命令记录到本地的命令历史文件。</li>
</ul>
<h4><a id="kill-query%E6%9C%AC%E8%B4%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>kill query本质</h4>
<ul>
<li>这些“kill 不掉”的情况，其实是因为发送 kill 命令的客户端，并没有强行停止目标线程的执行，而只是设置了个状态，并唤醒对应的线程。而被 kill 的线程，需要执行到判断状态的“埋点”，才会开始进入终止逻辑阶段。并且，终止逻辑本身也是需要耗费时间的</li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-02-10T10:18:15+08:00" itemprop="datePublished">2019/02/10 10:18 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15497650956334.html" itemprop="url">
		Innodb和Memory引擎</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="memory%E5%BC%95%E6%93%8E" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Memory引擎</h4>
<ul>
<li>InnoDB 引擎把数据放在主键索引上，其他索引上保存的是主键 id。这种方式，我们称之为索引组织表（Index Organizied Table）。</li>
<li>而 Memory 引擎采用的是把数据单独存放，索引上保存数据位置的数据组织形式，我们称之为堆组织表（Heap Organizied Table）。</li>
</ul>
<h4><a id="%E5%BC%95%E6%93%8E%E7%9A%84%E5%8C%BA%E5%88%AB" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>引擎的区别</h4>
<ul>
<li>InnoDB 表的数据总是有序存放的，而内存表的数据就是按照写入顺序存放的；</li>
<li>当数据文件有空洞的时候，InnoDB 表在插入新数据的时候，为了保证数据有序性，只能在固定的位置写入新值，而内存表找到空位就可以插入新值；</li>
<li>数据位置发生变化的时候，InnoDB 表只需要修改主键索引，而内存表需要修改所有索引；</li>
<li>InnoDB 表用主键索引查询时需要走一次索引查找，用普通索引查询的时候，需要走两次索引查找。而内存表没有这个区别，所有索引的“地位”都是相同的。</li>
<li>InnoDB 支持变长数据类型，不同记录的长度可能不同；内存表不支持 Blob 和 Text 字段，并且即使定义了 varchar(N)，实际也当作 char(N)，也就是固定长度字符串来存储，因此内存表的每行数据长度相同</li>
</ul>
<h4><a id="%E5%86%85%E5%AD%98%E5%BC%95%E6%93%8E%E7%9A%84%E9%97%AE%E9%A2%98" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>内存引擎的问题</h4>
<ul>
<li>锁粒度问题 不支持行锁</li>
<li>数据持久化问题</li>
<li>备库重启会导致主备同步停止</li>
<li>备库重启后删除内存临时表，在双M的结构中会把另外一个主库的内存表也清除</li>
</ul>
<h4><a id="%E5%86%85%E5%AD%98%E4%B8%B4%E6%97%B6%E8%A1%A8%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>内存临时表可以使用的原因</h4>
<ul>
<li>临时表不会被其他线程访问，没有并发性的问题；</li>
<li>临时表重启后也是需要删除的，清空数据这个问题不存在；</li>
<li>备库的临时表也不会影响主库的用户线程。</li>
</ul>
<h4><a id="" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a></h4>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2019-02-13T11:10:58+08:00" itemprop="datePublished">2019/02/13 11:10 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15500274588408.html" itemprop="url">
		insert语句的锁</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="insert%E5%BE%AA%E7%8E%AF%E5%86%99%E5%85%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>insert循环写入</h4>
<ul>
<li>导致在表 t 上做全表扫描，并且会给索引 c 上的所有间隙都加上共享的 next-key lock。所以，这个语句执行期间，其他事务不能在这个表上插入数据</li>
<li>一边遍历数据，一边更新数据的情况，如果读出来的数据直接写回原表，就可能在遍历过程中，读到刚刚插入的记录，新插入的记录如果参与计算逻辑，就跟语义不符</li>
</ul>
<h4><a id="insert%E5%94%AF%E4%B8%80%E9%94%AE%E5%86%B2%E7%AA%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>insert唯一键冲突</h4>
<ul>
<li>冲突后主键和唯一健索引冲突加的都是next-key lock</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2021-02-07T15:49:19+08:00" itemprop="datePublished">2021/02/07 15:49 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16126841596075.html" itemprop="url">
		mysql语句执行计划</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="rows%E5%92%8Cfilterd" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>rows和filterd</h4>
<ul>
<li>最后简单说一下 rows 和 filtered，这个 rows 顾名思义，就是说你使用指定的查询方式，会查出来多少条数据，而 filtered 意思就是说，在查询方式查出来的这波数据里再用上其他的不在索引范围里的查询条件，又会过滤出来百分之几的数据。</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2021-02-02T09:45:21+08:00" itemprop="datePublished">2021/02/02 09:45 上午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="16122303216221.html" itemprop="url">
		Mysql explain用法</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>性能比较</h4>
<p>ALL &lt; index &lt; range ~ index_merge &lt; ref &lt; eq_ref &lt; const &lt; system</p>
<h4><a id="type%E7%B1%BB%E5%9E%8B" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>type类型</h4>
<ul>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2018-11-30T16:45:09+08:00" itemprop="datePublished">2018/11/30 16:45 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15435675098509.html" itemprop="url">
		事物隔离</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h4><a id="mysql%E8%A7%86%E5%9B%BE" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mysql视图</h4>
<ul>
<li>一个是 view。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。创建视图的语法是 create view，而它的查询方法与表一样。</li>
<li>InnoDB 在实现 MVCC 时用到的一致性读视图，即 consistent read view，用于支持 RC（Read Committed，读提交）和 RR（Repeatable Read，可重复度）隔离级别的实现。</li>
</ul>
<h4><a id="%E4%BA%8B%E7%89%A9%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E8%A7%84%E5%88%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>事物更新数据规则</h4>
<ul>
<li>更新数据都是先读后写的，而这个读，只能读当前的值，称为“当前读（current read）”。</li>
</ul>
<h4><a id="%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E5%92%8C%E8%AF%BB%E6%8F%90%E4%BA%A4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>可重复读和读提交</h4>
<ul>
<li>可重复读的核心就是一致性读（consistent read）；而事务更新数据的时候，只能用当前读。如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。</li>
<li>在读提交隔离级别下，每一个语句执行前都会重新算一次 up_limit_id 的值</li>
<li>对于可重复读，查询只承认在事务启动前就已经提交完成的数据；</li>
<li>对于读提交，查询只承认在语句启动前就已经提交完成的数据；</li>
</ul>
<h4><a id="%E4%BA%8B%E7%89%A9%E5%90%AF%E5%8A%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>事物启动</h4>
<ul>
<li>begin/start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个操作 InnoDB 表的语句，事务才真正启动。如果你想要马上启动一个事务，可以使用 start transaction with consistent snapshot 这个命令。</li>
<li></li>
</ul>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2018-12-11T18:38:26+08:00" itemprop="datePublished">2018/12/11 18:38 下午</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='Mysql%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98.html'>Mysql优化实战</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15445247066236.html" itemprop="url">
		Mysql抖动</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h5><a id="%E4%B8%B4%E6%97%B6%E5%85%B3%E9%97%ADbinlog" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>临时关闭binlog</h5>
<p>set sql_log_bin=OFF;</p>
<h4><a id="%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E7%9A%84iops" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>测试磁盘的IOPS</h4>
<ul>
<li>fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest</li>
<li>机械硬盘 IOPS 1045</li>
<li>SATA固态 IOPS 6200</li>
<li>M2.0固态 IOPS 13000</li>
</ul>
<h4><a id="mysql%E5%8F%98%E6%85%A2%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mysql变慢的原因</h4>
<ul>
<li>正在flush刷新脏页面</li>
</ul>
<h4><a id="%E5%86%85%E5%AD%98%E8%84%8F%E6%95%B0%E6%8D%AE%E4%B8%8D%E6%B7%98%E6%B1%B0%E7%9A%84%E5%8E%9F%E5%9B%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>内存脏数据不淘汰的原因</h4>
<ul>
<li>一种是内存里存在，内存里就肯定是正确的结果，直接返回；</li>
<li>另一种是内存里没有数据，就可以肯定数据文件上是正确的结果，读入内存后返回。<br />
这样的效率最高</li>
</ul>
<h4><a id="%E5%86%85%E5%AD%98buffer-pool" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>内存buffer pool</h4>
<ul>
<li>第一种是，还没有使用的；</li>
<li>第二种是，使用了并且是干净页；</li>
<li>第三种是，使用了并且是脏页。</li>
</ul>
<h4><a id="%E8%84%8F%E9%A1%B5%E6%AF%94%E4%BE%8B%E7%9A%84%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>脏页比例的控制策略</h4>
<ul>
<li>innodb_io_capacity 和磁盘的IOPS</li>
<li>innodb_max_dirty_pages_pct 脏页比例上限</li>
</ul>
<h4><a id="%E8%84%8F%E9%A1%B5%E5%88%B7%E7%9B%98%E9%80%9F%E5%BA%A6%E5%8F%82%E8%80%83%E5%9B%A0%E7%B4%A0" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>脏页刷盘速度参考因素</h4>
<ul>
<li>脏页比例</li>
<li>redo log写盘速度</li>
<li>R = (脏页比例(max_dirty_pages_pact, (当前序列号 - checkpoint)N)</li>
<li>脏页刷新速度 = innodb_io_capacity  * R%<br />
<img src="media/15445247066236/cc44c1d080141aa50df6a91067475374.png" alt="cc44c1d080141aa50df6a91067475374" /></li>
<li>影响刷脏页的速度</li>
</ul>
<h4><a id="%E4%BC%98%E5%8C%96" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>优化</h4>
<ul>
<li>SSD不需要了 innodb_flush_neighbors = 0</li>
</ul>
<h4><a id="%E7%A1%AE%E5%AE%9A%E5%86%85%E5%AD%98%E8%84%8F%E9%A1%B5%E9%9D%A2" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>确定内存脏页面</h4>
<ul>
<li>每个数据页头部有LSN，8字节，每次修改都会变大。</li>
<li>对比这个LSN跟checkpoint 的LSN，比checkpoint小的一定是干净页</li>
<li>flush是内存脏页直接过redo-log现在redo log 需要往前推进checkpoint，到LSN为12的这条log时，发现内存中的脏页列表里没有该页，且磁盘上该页的LSN也已经为12，则该页已刷脏，已为干净页，跳过。</li>
<li>innodb_max_dirty_pages_pct 脏页比例</li>
</ul>
<h4><a id="relog%E5%BE%88%E5%B0%8F%E7%9A%84%E5%90%8E%E6%9E%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>relog很小的后果</h4>
<ul>
<li>io压力不大，但是数据库性能下降</li>
</ul>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 <a class="prev" href="Mysql优化实战.html">Prev</a>  
	 <a class="next" href="Mysql优化实战_2.html">Next</a> 
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    



</body>
</html>